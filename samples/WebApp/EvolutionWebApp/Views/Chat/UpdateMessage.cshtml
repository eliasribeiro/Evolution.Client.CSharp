@{
    ViewData["Title"] = "Atualizar Mensagem";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-edit"></i>
                        Atualizar Mensagem
                    </h3>
                </div>
                <div class="card-body">
                    <form id="updateMessageForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="instanceName">Nome da Instância:</label>
                                    <input type="text" class="form-control" id="instanceName" name="instanceName" required>
                                    <small class="form-text text-muted">Nome da instância do WhatsApp</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="number">Número do Telefone:</label>
                                    <input type="text" class="form-control" id="number" name="number" required>
                                    <small class="form-text text-muted">Número com código do país (ex: 5511999999999)</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="messageId">ID da Mensagem:</label>
                                    <input type="text" class="form-control" id="messageId" name="messageId" required>
                                    <small class="form-text text-muted">ID único da mensagem a ser atualizada</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="remoteJid">Remote JID:</label>
                                    <input type="text" class="form-control" id="remoteJid" name="remoteJid" required>
                                    <small class="form-text text-muted">JID do chat (ex: 5511999999999@s.whatsapp.net)</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="text">Novo Texto da Mensagem:</label>
                                    <textarea class="form-control" id="text" name="text" rows="4" required></textarea>
                                    <small class="form-text text-muted">Novo conteúdo que substituirá o texto atual da mensagem</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="fromMe" name="fromMe">
                                        <label class="form-check-label" for="fromMe">
                                            Mensagem enviada por mim
                                        </label>
                                        <small class="form-text text-muted d-block">Marque se a mensagem foi enviada pela sua instância</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-edit"></i>
                                    Atualizar Mensagem
                                </button>
                                <button type="button" class="btn btn-secondary ml-2" onclick="clearForm()">
                                    <i class="fas fa-eraser"></i>
                                    Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção de Resultados -->
    <div class="row mt-4" id="resultSection" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-check-circle"></i>
                        Resultado da Atualização
                    </h3>
                </div>
                <div class="card-body">
                    <div id="resultContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção de Informações -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-info-circle"></i>
                        Informações
                    </h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h5><i class="fas fa-lightbulb"></i> Como usar:</h5>
                        <ul>
                            <li><strong>Nome da Instância:</strong> Informe o nome da sua instância do WhatsApp</li>
                            <li><strong>Número do Telefone:</strong> Número com código do país (ex: 5511999999999)</li>
                            <li><strong>ID da Mensagem:</strong> ID único da mensagem que você deseja atualizar</li>
                            <li><strong>Remote JID:</strong> Identificador do chat (contato ou grupo)</li>
                            <li><strong>Novo Texto:</strong> O conteúdo que substituirá o texto atual da mensagem</li>
                            <li><strong>Mensagem enviada por mim:</strong> Marque se a mensagem foi enviada pela sua instância</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção de Dicas -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-tips"></i>
                        Dicas Importantes
                    </h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <h5><i class="fas fa-exclamation-triangle"></i> Observações:</h5>
                        <ul>
                            <li><strong>Limitações:</strong> Só é possível atualizar mensagens de texto</li>
                            <li><strong>Tempo:</strong> Mensagens muito antigas podem não ser atualizáveis</li>
                            <li><strong>Permissões:</strong> Você só pode atualizar mensagens que enviou</li>
                            <li><strong>Remote JID:</strong> Para contatos use formato: número@s.whatsapp.net</li>
                            <li><strong>Remote JID:</strong> Para grupos use o ID do grupo fornecido pela API</li>
                            <li><strong>Validação:</strong> Certifique-se de que todos os dados estão corretos</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('updateMessageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    updateMessage();
});

async function updateMessage() {
    const instanceName = document.getElementById('instanceName').value.trim();
    const number = document.getElementById('number').value.trim();
    const text = document.getElementById('text').value.trim();
    const messageId = document.getElementById('messageId').value.trim();
    const remoteJid = document.getElementById('remoteJid').value.trim();
    const fromMe = document.getElementById('fromMe').checked;

    if (!instanceName || !number || !text || !messageId || !remoteJid) {
        showAlert('Todos os campos obrigatórios devem ser preenchidos.', 'warning');
        return;
    }

    const submitButton = document.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
    submitButton.disabled = true;

    try {
        const formData = new FormData();
        formData.append('instanceName', instanceName);
        formData.append('number', number);
        formData.append('text', text);
        formData.append('messageId', messageId);
        formData.append('remoteJid', remoteJid);
        formData.append('fromMe', fromMe);

        const response = await fetch('/Chat/UpdateMessage', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            showResult(result.data, result.message);
            showAlert(result.message, 'success');
        } else {
            showAlert(result.message, 'danger');
            hideResult();
        }
    } catch (error) {
        console.error('Erro:', error);
        showAlert('Erro ao processar a solicitação. Tente novamente.', 'danger');
        hideResult();
    } finally {
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
    }
}

function showResult(data, message) {
    const resultSection = document.getElementById('resultSection');
    const resultContent = document.getElementById('resultContent');
    
    let html = `
        <div class="alert alert-success">
            <h5><i class="fas fa-check-circle"></i> ${message}</h5>
        </div>
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-key"></i> Informações da Mensagem:</h6>
                <ul class="list-group list-group-flush">
    `;

    if (data.key) {
        html += `
                    <li class="list-group-item"><strong>ID:</strong> ${data.key.id || 'N/A'}</li>
                    <li class="list-group-item"><strong>Remote JID:</strong> ${data.key.remoteJid || 'N/A'}</li>
                    <li class="list-group-item"><strong>From Me:</strong> ${data.key.fromMe ? 'Sim' : 'Não'}</li>
        `;
    }

    html += `
                </ul>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-info-circle"></i> Detalhes:</h6>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item"><strong>Timestamp:</strong> ${data.messageTimestamp || 'N/A'}</li>
                    <li class="list-group-item"><strong>Status:</strong> ${data.status || 'N/A'}</li>
                </ul>
            </div>
        </div>
    `;

    if (data.message) {
        html += `
        <div class="row mt-3">
            <div class="col-12">
                <h6><i class="fas fa-comment"></i> Conteúdo da Mensagem:</h6>
                <div class="card">
                    <div class="card-body">
        `;

        if (data.message.conversation) {
            html += `<p><strong>Texto:</strong> ${data.message.conversation}</p>`;
        }

        if (data.message.extendedTextMessage && data.message.extendedTextMessage.text) {
            html += `<p><strong>Texto Estendido:</strong> ${data.message.extendedTextMessage.text}</p>`;
        }

        html += `
                    </div>
                </div>
            </div>
        </div>
        `;
    }

    resultContent.innerHTML = html;
    resultSection.style.display = 'block';
    resultSection.scrollIntoView({ behavior: 'smooth' });
}

function hideResult() {
    document.getElementById('resultSection').style.display = 'none';
}

function clearForm() {
    document.getElementById('updateMessageForm').reset();
    hideResult();
    showAlert('Formulário limpo com sucesso!', 'info');
}

function showAlert(message, type) {
    // Remove alertas existentes
    const existingAlerts = document.querySelectorAll('.alert-dismissible');
    existingAlerts.forEach(alert => alert.remove());

    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;

    // Insere o alerta no topo da página
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);

    // Remove o alerta automaticamente após 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>