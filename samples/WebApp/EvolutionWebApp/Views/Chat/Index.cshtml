@{
    ViewData["Title"] = "Chat - Verificar WhatsApp";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-comments text-success"></i> Chat - Verificar WhatsApp</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Dashboard</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Chat</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-search"></i> Verificar Números no WhatsApp
                    </h5>
                </div>
                <div class="card-body">
                    <form id="checkWhatsAppForm">
                        <div class="mb-3">
                            <label for="instanceName" class="form-label">Instância <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="instanceName" name="instanceName" 
                                   placeholder="Digite o nome da instância" required>
                            <div class="form-text">Nome da instância conectada ao WhatsApp</div>
                        </div>

                        <div class="mb-3">
                            <label for="numbers" class="form-label">Números de Telefone <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="numbers" name="numbers" rows="6" 
                                      placeholder="Digite os números separados por vírgula ou quebra de linha&#10;Exemplo:&#10;5561999887766&#10;5561888776655&#10;5561777665544" required></textarea>
                            <div class="form-text">
                                Digite os números com código do país (ex: 5561999887766)<br>
                                Separe múltiplos números por vírgula ou quebra de linha
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-success" id="checkButton">
                                <i class="fas fa-search"></i> Verificar Números
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle"></i> Como Usar
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-lightbulb"></i> Instruções:</h6>
                        <ol class="mb-0">
                            <li>Digite o nome de uma instância conectada</li>
                            <li>Insira os números de telefone com código do país</li>
                            <li>Separe múltiplos números por vírgula ou quebra de linha</li>
                            <li>Clique em "Verificar Números" para consultar</li>
                        </ol>
                    </div>

                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle"></i> Formato dos Números:</h6>
                        <ul class="mb-0">
                            <li><strong>Correto:</strong> 5561999887766</li>
                            <li><strong>Incorreto:</strong> (61) 99988-7766</li>
                            <li><strong>Incorreto:</strong> +55 61 9 9988-7766</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resultados -->
    <div class="row mt-4" id="resultsSection" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list"></i> Resultados da Verificação
                    </h5>
                </div>
                <div class="card-body">
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('#checkWhatsAppForm').on('submit', function(e) {
                e.preventDefault();
                checkWhatsAppNumbers();
            });
        });

        function checkWhatsAppNumbers() {
            const instanceName = $('#instanceName').val().trim();
            const numbers = $('#numbers').val().trim();
            const $button = $('#checkButton');
            const $resultsSection = $('#resultsSection');
            const $resultsContent = $('#resultsContent');

            if (!instanceName) {
                showAlert('danger', 'Nome da instância é obrigatório.');
                return;
            }

            if (!numbers) {
                showAlert('danger', 'Pelo menos um número deve ser fornecido.');
                return;
            }

            // Desabilita o botão e mostra loading
            $button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Verificando...');
            $resultsSection.hide();

            $.ajax({
                url: '@Url.Action("CheckWhatsApp", "Chat")',
                type: 'POST',
                data: {
                    instanceName: instanceName,
                    numbers: numbers
                },
                success: function(response) {
                    if (response.success) {
                        showAlert('success', response.message);
                        displayResults(response.data);
                        $resultsSection.show();
                    } else {
                        showAlert('danger', response.message);
                        $resultsSection.hide();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Erro na requisição:', error);
                    showAlert('danger', 'Erro ao verificar números. Tente novamente.');
                    $resultsSection.hide();
                },
                complete: function() {
                    // Reabilita o botão
                    $button.prop('disabled', false).html('<i class="fas fa-search"></i> Verificar Números');
                }
            });
        }

        function displayResults(data) {
            const $content = $('#resultsContent');
            
            if (!data || data.length === 0) {
                $content.html('<div class="alert alert-warning">Nenhum resultado encontrado.</div>');
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-striped table-hover">';
            html += '<thead class="table-dark">';
            html += '<tr>';
            html += '<th>Número</th>';
            html += '<th>Status</th>';
            html += '<th>Nome</th>';
            html += '<th>JID</th>';
            html += '</tr>';
            html += '</thead>';
            html += '<tbody>';

            data.forEach(function(item) {
                const statusBadge = item.exists 
                    ? '<span class="badge bg-success"><i class="fas fa-check"></i> Existe</span>'
                    : '<span class="badge bg-danger"><i class="fas fa-times"></i> Não existe</span>';
                
                const name = item.name || '<span class="text-muted">-</span>';
                
                html += '<tr>';
                html += `<td><strong>${item.number}</strong></td>`;
                html += `<td>${statusBadge}</td>`;
                html += `<td>${name}</td>`;
                html += `<td><small class="text-muted">${item.jid}</small></td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';

            // Estatísticas
            const existsCount = data.filter(item => item.exists).length;
            const notExistsCount = data.length - existsCount;

            html += '<div class="row mt-3">';
            html += '<div class="col-md-4">';
            html += `<div class="card bg-primary text-white">`;
            html += `<div class="card-body text-center">`;
            html += `<h5>${data.length}</h5>`;
            html += `<small>Total Verificados</small>`;
            html += `</div></div></div>`;
            
            html += '<div class="col-md-4">';
            html += `<div class="card bg-success text-white">`;
            html += `<div class="card-body text-center">`;
            html += `<h5>${existsCount}</h5>`;
            html += `<small>Existem no WhatsApp</small>`;
            html += `</div></div></div>`;
            
            html += '<div class="col-md-4">';
            html += `<div class="card bg-danger text-white">`;
            html += `<div class="card-body text-center">`;
            html += `<h5>${notExistsCount}</h5>`;
            html += `<small>Não existem</small>`;
            html += `</div></div></div>`;
            html += '</div>';

            $content.html(html);
        }

        function showAlert(type, message) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            // Remove alertas anteriores
            $('.alert').remove();
            
            // Adiciona o novo alerta no topo da página
            $('.container-fluid').prepend(alertHtml);
            
            // Auto-remove após 5 segundos
            setTimeout(function() {
                $('.alert').fadeOut();
            }, 5000);
        }
    </script>
}